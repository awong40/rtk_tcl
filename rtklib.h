//
//  rtklib.h
//  rtklib
//
//  Created by evarady on 5/10/18.
//  Copyright Â© 2018 anissa. All rights reserved.
//


#ifndef RTKLIB_H
#define RTKLIB_H
#include <stdio.h>
#include <stdlib.h>
#include <stdarg.h>
#include <string.h>
#include <math.h>
#include <time.h>
#include <ctype.h>
#include <pthread.h>
#endif
#ifdef __cplusplus
extern "C" {
#endif
#define RE_WGS84    6378137.0           /* earth semimajor axis (WGS84) (m) */
#define FE_WGS84    (1.0/298.257223563) /* earth flattening (WGS84) */
    
#define PI          3.1415926535897932  /* pi */
#define D2R         (PI/180.0)          /* deg to rad */
#define R2D         (180.0/PI)          /* rad to deg */
#define CLIGHT      299792458.0         /* speed of light (m/s) */
    
#define EFACT_GPS   1.0                 /* error factor: GPS */
#define EFACT_GLO   1.5                 /* error factor: GLONASS */
    
#define EFACT_SBS   3.0                 /* error factor: SBAS */
    
#define SYS_GPS     0x01                /* navigation system: GPS */
#define SYS_SBS     0x02                /* navigation system: SBAS */
#define SYS_GLO     0x04                /* navigation system: GLONASS */
#define SYS_GAL     0x08                /* navigation system: Galileo */
    
#define SYS_CMP     0x20                /* navigation system: BeiDou */
    
#ifndef NFREQ
#define NFREQ       3                   /* number of carrier frequencies */
#endif
    
#ifndef NEXOBS
#define NEXOBS      0                   /* number of extended obs codes */
#endif
    
#define MINPRNGPS   1                   /* min satellite PRN number of GPS */
#define MAXPRNGPS   32                  /* max satellite PRN number of GPS */
#define NSATGPS     (MAXPRNGPS-MINPRNGPS+1) /* number of GPS satellites */
#define NSYSGPS     1
    
#ifdef ENAGLO
    
#else
#define MINPRNGLO   0
#define MAXPRNGLO   0
#define NSATGLO     0
#define NSYSGLO     0
#endif
#ifdef ENAGAL
    
#else
#define MINPRNGAL   0
#define MAXPRNGAL   0
#define NSATGAL     0
#define NSYSGAL     0
#endif
#ifdef ENAQZS
    
#else
#define MINPRNQZS   0
#define MAXPRNQZS   0
#define MINPRNQZS_S 0
#define MAXPRNQZS_S 0
#define NSATQZS     0
#define NSYSQZS     0
#endif
#ifdef ENACMP
    
#else
#define MINPRNCMP   0
#define MAXPRNCMP   0
#define NSATCMP     0
#define NSYSCMP     0
#endif
#ifdef ENALEO
    
#else
#define MINPRNLEO   0
#define MAXPRNLEO   0
#define NSATLEO     0
#define NSYSLEO     0
#endif
    
#define MINPRNSBS   120                 /* min satellite PRN number of SBAS */
#define MAXPRNSBS   142                 /* max satellite PRN number of SBAS */
#define NSATSBS     (MAXPRNSBS-MINPRNSBS+1) /* number of SBAS satellites */
    
#define MAXSAT      (NSATGPS+NSATGLO+NSATGAL+NSATQZS+NSATCMP+NSATSBS+NSATLEO)
    
#ifndef MAXOBS
#define MAXOBS      64                  /* max number of obs in an epoch */
#endif
    
#define MAXOBSTYPE  64                  /* max number of obs type in RINEX */
    
#define MAXBAND     10                  /* max SBAS band of IGP */
#define MAXNIGP     201                 /* max number of IGP in SBAS band */
    
#define MAXCOMMENT  10                  /* max number of RINEX comments */
#define MAXSTRPATH  1024                /* max length of stream path */
#define MAXSTRMSG   1024                /* max length of stream message */
    
#define MAXSBSMSG   32                  /* max number of SBAS msg in RTK server */
#define MAXSOLMSG   4096                /* max length of solution message */
#define MAXRAWLEN   8192                /* max length of receiver raw message */
#define MAXERRMSG   4096                /* max length of error/warning message */
#define MAXANT      64                  /* max length of station name/antenna type */
#define MAXSOLBUF   256                 /* max number of solution buffer */
#define MAXOBSBUF   128                 /* max number of observation data buffer */
#define MAXNRPOS    16                  /* max number of reference positions */
    
#define MAXCODE     48                  /* max number of obs code */
    
#define PMODE_SINGLE 0                  /* positioning mode: single */
    
#define IONOOPT_IFLC 3                  /* ionosphere option: L1/L2 or L1/L5 iono-free LC */
    
#ifndef EXTLEX
#define MAXRCVFMT    12                 /* max number of receiver format */
#else
#define MAXRCVFMT    13
#endif
    
#ifdef WIN32
#else
#define thread_t    pthread_t
#define lock_t      pthread_mutex_t
#define initlock(f) pthread_mutex_init(f,NULL)
#define lock(f)     pthread_mutex_lock(f)
#define unlock(f)   pthread_mutex_unlock(f)
#define FILEPATHSEP '/'
#endif
    
    /* type definitions ----------------------------------------------------------*/
    typedef struct {        /* time struct */
        time_t time;        /* time (s) expressed by standard time_t */
        double sec;         /* fraction of second under 1 s */
    } gtime_t;
    typedef struct {        /* solution type */
        gtime_t time;       /* time (GPST) */
        double rr[6];       /* position/velocity (m|m/s) */
        /* {x,y,z,vx,vy,vz} or {e,n,u,ve,vn,vu} */
        float  qr[6];       /* position variance/covariance (m^2) */
        /* {c_xx,c_yy,c_zz,c_xy,c_yz,c_zx} or */
        /* {c_ee,c_nn,c_uu,c_en,c_nu,c_ue} */
        double dtr[6];      /* receiver clock bias to time systems (s) */
        unsigned char type; /* type (0:xyz-ecef,1:enu-baseline) */
        unsigned char stat; /* solution status (SOLQ_???) */
        unsigned char ns;   /* number of valid satellites */
        float age;          /* age of differential (s) */
        float ratio;        /* AR ratio factor for valiation */
    } sol_t;
    
    typedef struct {        /* observation data record */
        gtime_t time;       /* receiver sampling time (GPST) */
        unsigned char sat,rcv; /* satellite/receiver number */
        unsigned char SNR [NFREQ+NEXOBS]; /* signal strength (0.25 dBHz) */
        unsigned char LLI [NFREQ+NEXOBS]; /* loss of lock indicator */
        unsigned char code[NFREQ+NEXOBS]; /* code indicator (CODE_???) */
        double L[NFREQ+NEXOBS]; /* observation data carrier-phase (cycle) */
        double P[NFREQ+NEXOBS]; /* observation data pseudorange (m) */
        float  D[NFREQ+NEXOBS]; /* observation data doppler frequency (Hz) */
    } obsd_t;
    
    typedef struct {        /* observation data */
        int n,nmax;         /* number of obervation data/allocated */
        obsd_t *data;       /* observation data records */
    } obs_t;
    
    typedef struct {        /* earth rotation parameter data type */
        double mjd;         /* mjd (days) */
        double xp,yp;       /* pole offset (rad) */
        double xpr,ypr;     /* pole offset rate (rad/day) */
        double ut1_utc;     /* ut1-utc (s) */
        double lod;         /* length of day (s/day) */
    } erpd_t;
    
    typedef struct {        /* earth rotation parameter type */
        int n,nmax;         /* number and max number of data */
        erpd_t *data;       /* earth rotation parameter data */
    } erp_t;
    
    typedef struct {        /* antenna parameter type */
        int sat;            /* satellite number (0:receiver) */
        char type[MAXANT];  /* antenna type */
        char code[MAXANT];  /* serial number or satellite code */
        gtime_t ts,te;      /* valid time start and end */
        double off[NFREQ][ 3]; /* phase center offset e/n/u or x/y/z (m) */
        double var[NFREQ][19]; /* phase center variation (m) */
        /* el=90,85,...,0 or nadir=0,1,2,3,... (deg) */
    } pcv_t;
    
    typedef struct {        /* antenna parameters type */
        int n,nmax;         /* number of data/allocated */
        pcv_t *pcv;         /* antenna parameters data */
    } pcvs_t;
    
    typedef struct {        /* almanac type */
        int sat;            /* satellite number */
        int svh;            /* sv health (0:ok) */
        int svconf;         /* as and sv config */
        int week;           /* GPS/QZS: gps week, GAL: galileo week */
        gtime_t toa;        /* Toa */
        /* SV orbit parameters */
        double A,e,i0,OMG0,omg,M0,OMGd;
        double toas;        /* Toa (s) in week */
        double f0,f1;       /* SV clock parameters (af0,af1) */
    } alm_t;
    
    typedef struct {        /* GPS/QZS/GAL broadcast ephemeris type */
        int sat;            /* satellite number */
        int iode,iodc;      /* IODE,IODC */
        int sva;            /* SV accuracy (URA index) */
        int svh;            /* SV health (0:ok) */
        int week;           /* GPS/QZS: gps week, GAL: galileo week */
        int code;           /* GPS/QZS: code on L2, GAL/CMP: data sources */
        int flag;           /* GPS/QZS: L2 P data flag, CMP: nav type */
        gtime_t toe,toc,ttr; /* Toe,Toc,T_trans */
        /* SV orbit parameters */
        double A,e,i0,OMG0,omg,M0,deln,OMGd,idot;
        double crc,crs,cuc,cus,cic,cis;
        double toes;        /* Toe (s) in week */
        double fit;         /* fit interval (h) */
        double f0,f1,f2;    /* SV clock parameters (af0,af1,af2) */
        double tgd[4];      /* group delay parameters */
        /* GPS/QZS:tgd[0]=TGD */
        /* GAL    :tgd[0]=BGD E5a/E1,tgd[1]=BGD E5b/E1 */
        /* CMP    :tgd[0]=BGD1,tgd[1]=BGD2 */
        double Adot,ndot;   /* Adot,ndot for CNAV */
    } eph_t;
    
    typedef struct {        /* GLONASS broadcast ephemeris type */
        int sat;            /* satellite number */
        int iode;           /* IODE (0-6 bit of tb field) */
        int frq;            /* satellite frequency number */
        int svh,sva,age;    /* satellite health, accuracy, age of operation */
        gtime_t toe;        /* epoch of epherides (gpst) */
        gtime_t tof;        /* message frame time (gpst) */
        double pos[3];      /* satellite position (ecef) (m) */
        double vel[3];      /* satellite velocity (ecef) (m/s) */
        double acc[3];      /* satellite acceleration (ecef) (m/s^2) */
        double taun,gamn;   /* SV clock bias (s)/relative freq bias */
        double dtaun;       /* delay between L1 and L2 (s) */
    } geph_t;
    
    typedef struct {        /* precise ephemeris type */
        gtime_t time;       /* time (GPST) */
        int index;          /* ephemeris index for multiple files */
        double pos[MAXSAT][4]; /* satellite position/clock (ecef) (m|s) */
        float  std[MAXSAT][4]; /* satellite position/clock std (m|s) */
        double vel[MAXSAT][4]; /* satellite velocity/clk-rate (m/s|s/s) */
        float  vst[MAXSAT][4]; /* satellite velocity/clk-rate std (m/s|s/s) */
        float  cov[MAXSAT][3]; /* satellite position covariance (m^2) */
        float  vco[MAXSAT][3]; /* satellite velocity covariance (m^2) */
    } peph_t;
    
    typedef struct {        /* precise clock type */
        gtime_t time;       /* time (GPST) */
        int index;          /* clock index for multiple files */
        double clk[MAXSAT][1]; /* satellite clock (s) */
        float  std[MAXSAT][1]; /* satellite clock std (s) */
    } pclk_t;
    
    typedef struct {        /* SBAS ephemeris type */
        int sat;            /* satellite number */
        gtime_t t0;         /* reference epoch time (GPST) */
        gtime_t tof;        /* time of message frame (GPST) */
        int sva;            /* SV accuracy (URA index) */
        int svh;            /* SV health (0:ok) */
        double pos[3];      /* satellite position (m) (ecef) */
        double vel[3];      /* satellite velocity (m/s) (ecef) */
        double acc[3];      /* satellite acceleration (m/s^2) (ecef) */
        double af0,af1;     /* satellite clock-offset/drift (s,s/s) */
    } seph_t;
    
    typedef struct {        /* norad two line element data type */
        char name [32];     /* common name */
        char alias[32];     /* alias name */
        char satno[16];     /* satellilte catalog number */
        char satclass;      /* classification */
        char desig[16];     /* international designator */
        gtime_t epoch;      /* element set epoch (UTC) */
        double ndot;        /* 1st derivative of mean motion */
        double nddot;       /* 2st derivative of mean motion */
        double bstar;       /* B* drag term */
        int etype;          /* element set type */
        int eleno;          /* element number */
        double inc;         /* orbit inclination (deg) */
        double OMG;         /* right ascension of ascending node (deg) */
        double ecc;         /* eccentricity */
        double omg;         /* argument of perigee (deg) */
        double M;           /* mean anomaly (deg) */
        double n;           /* mean motion (rev/day) */
        int rev;            /* revolution number at epoch */
    } tled_t;
    
    typedef struct {        /* norad two line element type */
        int n,nmax;         /* number/max number of two line element data */
        tled_t *data;       /* norad two line element data */
    } tle_t;
    
    typedef struct {        /* TEC grid type */
        gtime_t time;       /* epoch time (GPST) */
        int ndata[3];       /* TEC grid data size {nlat,nlon,nhgt} */
        double rb;          /* earth radius (km) */
        double lats[3];     /* latitude start/interval (deg) */
        double lons[3];     /* longitude start/interval (deg) */
        double hgts[3];     /* heights start/interval (km) */
        double *data;       /* TEC grid data (tecu) */
        float *rms;         /* RMS values (tecu) */
    } tec_t;
    
    typedef struct {        /* stec data type */
        gtime_t time;       /* time (GPST) */
        unsigned char sat;  /* satellite number */
        unsigned char slip; /* slip flag */
        float iono;         /* L1 ionosphere delay (m) */
        float rate;         /* L1 ionosphere rate (m/s) */
        float rms;          /* rms value (m) */
    } stecd_t;
    
    typedef struct {        /* stec grid type */
        double pos[2];      /* latitude/longitude (deg) */
        int index[MAXSAT];  /* search index */
        int n,nmax;         /* number of data */
        stecd_t *data;      /* stec data */
    } stec_t;
    
    typedef struct {        /* zwd data type */
        gtime_t time;       /* time (GPST) */
        float zwd;          /* zenith wet delay (m) */
        float rms;          /* rms value (m) */
    } zwdd_t;
    
    typedef struct {        /* zwd grid type */
        float pos[2];       /* latitude,longitude (rad) */
        int n,nmax;         /* number of data */
        zwdd_t *data;       /* zwd data */
    } zwd_t;
    
    typedef struct {        /* SBAS message type */
        int week,tow;       /* receiption time */
        int prn;            /* SBAS satellite PRN number */
        unsigned char msg[29]; /* SBAS message (226bit) padded by 0 */
    } sbsmsg_t;
    
    typedef struct {        /* SBAS messages type */
        int n,nmax;         /* number of SBAS messages/allocated */
        sbsmsg_t *msgs;     /* SBAS messages */
    } sbs_t;
    
    typedef struct {        /* SBAS fast correction type */
        gtime_t t0;         /* time of applicability (TOF) */
        double prc;         /* pseudorange correction (PRC) (m) */
        double rrc;         /* range-rate correction (RRC) (m/s) */
        double dt;          /* range-rate correction delta-time (s) */
        int iodf;           /* IODF (issue of date fast corr) */
        short udre;         /* UDRE+1 */
        short ai;           /* degradation factor indicator */
    } sbsfcorr_t;
    
    typedef struct {        /* SBAS long term satellite error correction type */
        gtime_t t0;         /* correction time */
        int iode;           /* IODE (issue of date ephemeris) */
        double dpos[3];     /* delta position (m) (ecef) */
        double dvel[3];     /* delta velocity (m/s) (ecef) */
        double daf0,daf1;   /* delta clock-offset/drift (s,s/s) */
    } sbslcorr_t;
    
    typedef struct {        /* SBAS satellite correction type */
        int sat;            /* satellite number */
        sbsfcorr_t fcorr;   /* fast correction */
        sbslcorr_t lcorr;   /* long term correction */
    } sbssatp_t;
    
    typedef struct {        /* SBAS satellite corrections type */
        int iodp;           /* IODP (issue of date mask) */
        int nsat;           /* number of satellites */
        int tlat;           /* system latency (s) */
        sbssatp_t sat[MAXSAT]; /* satellite correction */
    } sbssat_t;
    
    typedef struct {        /* SBAS ionospheric correction type */
        gtime_t t0;         /* correction time */
        short lat,lon;      /* latitude/longitude (deg) */
        short give;         /* GIVI+1 */
        float delay;        /* vertical delay estimate (m) */
    } sbsigp_t;
    
    typedef struct {        /* IGP band type */
        short x;            /* longitude/latitude (deg) */
        const short *y;     /* latitudes/longitudes (deg) */
        unsigned char bits; /* IGP mask start bit */
        unsigned char bite; /* IGP mask end bit */
    } sbsigpband_t;
    
    typedef struct {        /* SBAS ionospheric corrections type */
        int iodi;           /* IODI (issue of date ionos corr) */
        int nigp;           /* number of igps */
        sbsigp_t igp[MAXNIGP]; /* ionospheric correction */
    } sbsion_t;
    
    typedef struct {        /* DGPS/GNSS correction type */
        gtime_t t0;         /* correction time */
        double prc;         /* pseudorange correction (PRC) (m) */
        double rrc;         /* range rate correction (RRC) (m/s) */
        int iod;            /* issue of data (IOD) */
        double udre;        /* UDRE */
    } dgps_t;
    
    typedef struct {        /* SSR correction type */
        gtime_t t0[5];      /* epoch time (GPST) {eph,clk,hrclk,ura,bias} */
        double udi[5];      /* SSR update interval (s) */
        int iod[5];         /* iod ssr {eph,clk,hrclk,ura,bias} */
        int iode;           /* issue of data */
        int iodcrc;         /* issue of data crc for beidou/sbas */
        int ura;            /* URA indicator */
        int refd;           /* sat ref datum (0:ITRF,1:regional) */
        double deph [3];    /* delta orbit {radial,along,cross} (m) */
        double ddeph[3];    /* dot delta orbit {radial,along,cross} (m/s) */
        double dclk [3];    /* delta clock {c0,c1,c2} (m,m/s,m/s^2) */
        double hrclk;       /* high-rate clock corection (m) */
        float cbias[MAXCODE]; /* code biases (m) */
        unsigned char update; /* update flag (0:no update,1:update) */
    } ssr_t;
    
    typedef struct {        /* QZSS LEX message type */
        int prn;            /* satellite PRN number */
        int type;           /* message type */
        int alert;          /* alert flag */
        unsigned char stat; /* signal tracking status */
        unsigned char snr;  /* signal C/N0 (0.25 dBHz) */
        unsigned int ttt;   /* tracking time (ms) */
        unsigned char msg[212]; /* LEX message data part 1695 bits */
    } lexmsg_t;
    
    typedef struct {        /* QZSS LEX messages type */
        int n,nmax;         /* number of LEX messages and allocated */
        lexmsg_t *msgs;     /* LEX messages */
    } lex_t;
    
    typedef struct {        /* QZSS LEX ephemeris type */
        gtime_t toe;        /* epoch time (GPST) */
        gtime_t tof;        /* message frame time (GPST) */
        int sat;            /* satellite number */
        unsigned char health; /* signal health (L1,L2,L1C,L5,LEX) */
        unsigned char ura;  /* URA index */
        double pos[3];      /* satellite position (m) */
        double vel[3];      /* satellite velocity (m/s) */
        double acc[3];      /* satellite acceleration (m/s2) */
        double jerk[3];     /* satellite jerk (m/s3) */
        double af0,af1;     /* satellite clock bias and drift (s,s/s) */
        double tgd;         /* TGD */
        double isc[8];      /* ISC */
    } lexeph_t;
    
    typedef struct {        /* QZSS LEX ionosphere correction type */
        gtime_t t0;         /* epoch time (GPST) */
        double tspan;       /* valid time span (s) */
        double pos0[2];     /* reference position {lat,lon} (rad) */
        double coef[3][2];  /* coefficients lat x lon (3 x 2) */
    } lexion_t;
    
    typedef struct {        /* navigation data type */
        int n,nmax;         /* number of broadcast ephemeris */
        int ng,ngmax;       /* number of glonass ephemeris */
        int ns,nsmax;       /* number of sbas ephemeris */
        int ne,nemax;       /* number of precise ephemeris */
        int nc,ncmax;       /* number of precise clock */
        int na,namax;       /* number of almanac data */
        int nt,ntmax;       /* number of tec grid data */
        int nn,nnmax;       /* number of stec grid data */
        eph_t *eph;         /* GPS/QZS/GAL ephemeris */
        geph_t *geph;       /* GLONASS ephemeris */
        seph_t *seph;       /* SBAS ephemeris */
        peph_t *peph;       /* precise ephemeris */
        pclk_t *pclk;       /* precise clock */
        alm_t *alm;         /* almanac data */
        tec_t *tec;         /* tec grid data */
        stec_t *stec;       /* stec grid data */
        erp_t  erp;         /* earth rotation parameters */
        double utc_gps[4];  /* GPS delta-UTC parameters {A0,A1,T,W} */
        double utc_glo[4];  /* GLONASS UTC GPS time parameters */
        double utc_gal[4];  /* Galileo UTC GPS time parameters */
        double utc_qzs[4];  /* QZS UTC GPS time parameters */
        double utc_cmp[4];  /* BeiDou UTC parameters */
        double utc_sbs[4];  /* SBAS UTC parameters */
        double ion_gps[8];  /* GPS iono model parameters {a0,a1,a2,a3,b0,b1,b2,b3} */
        double ion_gal[4];  /* Galileo iono model parameters {ai0,ai1,ai2,0} */
        double ion_qzs[8];  /* QZSS iono model parameters {a0,a1,a2,a3,b0,b1,b2,b3} */
        double ion_cmp[8];  /* BeiDou iono model parameters {a0,a1,a2,a3,b0,b1,b2,b3} */
        int leaps;          /* leap seconds (s) */
        double lam[MAXSAT][NFREQ]; /* carrier wave lengths (m) */
        double cbias[MAXSAT][3];   /* code bias (0:p1-p2,1:p1-c1,2:p2-c2) (m) */
        double wlbias[MAXSAT];     /* wide-lane bias (cycle) */
        double glo_cpbias[4];    /* glonass code-phase bias {1C,1P,2C,2P} (m) */
        char glo_fcn[MAXPRNGLO+1]; /* glonass frequency channel number + 8 */
        pcv_t pcvs[MAXSAT]; /* satellite antenna pcv */
        sbssat_t sbssat;    /* SBAS satellite corrections */
        sbsion_t sbsion[MAXBAND+1]; /* SBAS ionosphere corrections */
        dgps_t dgps[MAXSAT]; /* DGPS corrections */
        ssr_t ssr[MAXSAT];  /* SSR corrections */
        lexeph_t lexeph[MAXSAT]; /* LEX ephemeris */
        lexion_t lexion;    /* LEX ionosphere correction */
    } nav_t;
    
    typedef struct {        /* station parameter type */
        char name   [MAXANT]; /* marker name */
        char marker [MAXANT]; /* marker number */
        char antdes [MAXANT]; /* antenna descriptor */
        char antsno [MAXANT]; /* antenna serial number */
        char rectype[MAXANT]; /* receiver type descriptor */
        char recver [MAXANT]; /* receiver firmware version */
        char recsno [MAXANT]; /* receiver serial number */
        int antsetup;       /* antenna setup id */
        int itrf;           /* ITRF realization year */
        int deltype;        /* antenna delta type (0:enu,1:xyz) */
        double pos[3];      /* station position (ecef) (m) */
        double del[3];      /* antenna position delta (e/n/u or x/y/z) (m) */
        double hgt;         /* antenna height (m) */
    } sta_t;
    
    typedef struct {        /* solution buffer type */
        int n,nmax;         /* number of solution/max number of buffer */
        int cyclic;         /* cyclic buffer flag */
        int start,end;      /* start/end index */
        gtime_t time;       /* current solution time */
        sol_t *data;        /* solution data */
        double rb[3];       /* reference position {x,y,z} (ecef) (m) */
        unsigned char buff[MAXSOLMSG+1]; /* message buffer */
        int nb;             /* number of byte in message buffer */
    } solbuf_t;
    
    typedef struct {        /* solution status type */
        gtime_t time;       /* time (GPST) */
        unsigned char sat;  /* satellite number */
        unsigned char frq;  /* frequency (1:L1,2:L2,...) */
        float az,el;        /* azimuth/elevation angle (rad) */
        float resp;         /* pseudorange residual (m) */
        float resc;         /* carrier-phase residual (m) */
        unsigned char flag; /* flags: (vsat<<5)+(slip<<3)+fix */
        unsigned char snr;  /* signal strength (0.25 dBHz) */
        unsigned short lock;  /* lock counter */
        unsigned short outc;  /* outage counter */
        unsigned short slipc; /* slip counter */
        unsigned short rejc;  /* reject counter */
    } solstat_t;
    
    typedef struct {        /* solution status buffer type */
        int n,nmax;         /* number of solution/max number of buffer */
        solstat_t *data;    /* solution status data */
    } solstatbuf_t;
    
    typedef struct {        /* RTCM control struct type */
        int staid;          /* station id */
        int stah;           /* station health */
        int seqno;          /* sequence number for rtcm 2 or iods msm */
        int outtype;        /* output message type */
        gtime_t time;       /* message time */
        gtime_t time_s;     /* message start time */
        obs_t obs;          /* observation data (uncorrected) */
        nav_t nav;          /* satellite ephemerides */
        sta_t sta;          /* station parameters */
        dgps_t *dgps;       /* output of dgps corrections */
        ssr_t ssr[MAXSAT];  /* output of ssr corrections */
        char msg[128];      /* special message */
        char msgtype[256];  /* last message type */
        char msmtype[6][128]; /* msm signal types */
        int obsflag;        /* obs data complete flag (1:ok,0:not complete) */
        int ephsat;         /* update satellite of ephemeris */
        double cp[MAXSAT][NFREQ+NEXOBS]; /* carrier-phase measurement */
        unsigned short lock[MAXSAT][NFREQ+NEXOBS]; /* lock time */
        unsigned short loss[MAXSAT][NFREQ+NEXOBS]; /* loss of lock count */
        gtime_t lltime[MAXSAT][NFREQ+NEXOBS]; /* last lock time */
        int nbyte;          /* number of bytes in message buffer */
        int nbit;           /* number of bits in word buffer */
        int len;            /* message length (bytes) */
        unsigned char buff[1200]; /* message buffer */
        unsigned int word;  /* word buffer for rtcm 2 */
        unsigned int nmsg2[100]; /* message count of RTCM 2 (1-99:1-99,0:other) */
        unsigned int nmsg3[300]; /* message count of RTCM 3 (1-299:1001-1299,0:ohter) */
        char opt[256];      /* RTCM dependent options */
    } rtcm_t;
    
    typedef struct {        /* rinex control struct type */
        gtime_t time;       /* message time */
        double ver;         /* rinex version */
        char   type;        /* rinex file type ('O','N',...) */
        int    sys;         /* navigation system */
        int    tsys;        /* time system */
        char   tobs[6][MAXOBSTYPE][4]; /* rinex obs types */
        obs_t  obs;         /* observation data */
        nav_t  nav;         /* navigation data */
        sta_t  sta;         /* station info */
        int    ephsat;      /* ephemeris satellite number */
        char   opt[256];    /* rinex dependent options */
    } rnxctr_t;
    
    typedef struct {        /* download url type */
        char type[32];      /* data type */
        char path[1024];    /* url path */
        char dir [1024];    /* local directory */
        double tint;        /* time interval (s) */
    } url_t;
    
    typedef struct {        /* option type */
        char *name;         /* option name */
        int format;         /* option format (0:int,1:double,2:string,3:enum) */
        void *var;          /* pointer to option variable */
        char *comment;      /* option comment/enum labels/unit */
    } opt_t;
    
    typedef struct {        /* extended receiver error model */
        int ena[4];         /* model enabled */
        double cerr[4][NFREQ*2]; /* code errors (m) */
        double perr[4][NFREQ*2]; /* carrier-phase errors (m) */
        double gpsglob[NFREQ]; /* gps-glonass h/w bias (m) */
        double gloicb [NFREQ]; /* glonass interchannel bias (m/fn) */
    } exterr_t;
    
    typedef struct {        /* SNR mask type */
        int ena[2];         /* enable flag {rover,base} */
        double mask[NFREQ][9]; /* mask (dBHz) at 5,10,...85 deg */
    } snrmask_t;
    
    typedef struct {        /* processing options type */
        int mode;           /* positioning mode (PMODE_???) */
        int soltype;        /* solution type (0:forward,1:backward,2:combined) */
        int nf;             /* number of frequencies (1:L1,2:L1+L2,3:L1+L2+L5) */
        int navsys;         /* navigation system */
        double elmin;       /* elevation mask angle (rad) */
        snrmask_t snrmask;  /* SNR mask */
        int sateph;         /* satellite ephemeris/clock (EPHOPT_???) */
        int modear;         /* AR mode (0:off,1:continuous,2:instantaneous,3:fix and hold,4:ppp-ar) */
        int glomodear;      /* GLONASS AR mode (0:off,1:on,2:auto cal,3:ext cal) */
        int bdsmodear;      /* BeiDou AR mode (0:off,1:on) */
        int maxout;         /* obs outage count to reset bias */
        int minlock;        /* min lock count to fix ambiguity */
        int minfix;         /* min fix count to hold ambiguity */
        int ionoopt;        /* ionosphere option (IONOOPT_???) */
        int tropopt;        /* troposphere option (TROPOPT_???) */
        int dynamics;       /* dynamics model (0:none,1:velociy,2:accel) */
        int tidecorr;       /* earth tide correction (0:off,1:solid,2:solid+otl+pole) */
        int niter;          /* number of filter iteration */
        int codesmooth;     /* code smoothing window size (0:none) */
        int intpref;        /* interpolate reference obs (for post mission) */
        int sbascorr;       /* SBAS correction options */
        int sbassatsel;     /* SBAS satellite selection (0:all) */
        int rovpos;         /* rover position for fixed mode */
        int refpos;         /* base position for relative mode */
        /* (0:pos in prcopt,  1:average of single pos, */
        /*  2:read from file, 3:rinex header, 4:rtcm pos) */
        double eratio[NFREQ]; /* code/phase error ratio */
        double err[5];      /* measurement error factor */
        /* [0]:reserved */
        /* [1-3]:error factor a/b/c of phase (m) */
        /* [4]:doppler frequency (hz) */
        double std[3];      /* initial-state std [0]bias,[1]iono [2]trop */
        double prn[5];      /* process-noise std [0]bias,[1]iono [2]trop [3]acch [4]accv */
        double sclkstab;    /* satellite clock stability (sec/sec) */
        double thresar[4];  /* AR validation threshold */
        double elmaskar;    /* elevation mask of AR for rising satellite (deg) */
        double elmaskhold;  /* elevation mask to hold ambiguity (deg) */
        double thresslip;   /* slip threshold of geometry-free phase (m) */
        double maxtdiff;    /* max difference of time (sec) */
        double maxinno;     /* reject threshold of innovation (m) */
        double maxgdop;     /* reject threshold of gdop */
        double baseline[2]; /* baseline length constraint {const,sigma} (m) */
        double ru[3];       /* rover position for fixed mode {x,y,z} (ecef) (m) */
        double rb[3];       /* base position for relative mode {x,y,z} (ecef) (m) */
        char anttype[2][MAXANT]; /* antenna types {rover,base} */
        double antdel[2][3]; /* antenna delta {{rov_e,rov_n,rov_u},{ref_e,ref_n,ref_u}} */
        pcv_t pcvr[2];      /* receiver antenna parameters {rov,base} */
        unsigned char exsats[MAXSAT]; /* excluded satellites (1:excluded,2:included) */
        char rnxopt[2][256]; /* rinex options {rover,base} */
        int  posopt[6];     /* positioning options */
        int  syncsol;       /* solution sync mode (0:off,1:on) */
        double odisp[2][6*11]; /* ocean tide loading parameters {rov,base} */
        exterr_t exterr;    /* extended receiver error model */
    } prcopt_t;
    
    typedef struct {        /* solution options type */
        int posf;           /* solution format (SOLF_???) */
        int times;          /* time system (TIMES_???) */
        int timef;          /* time format (0:sssss.s,1:yyyy/mm/dd hh:mm:ss.s) */
        int timeu;          /* time digits under decimal point */
        int degf;           /* latitude/longitude format (0:ddd.ddd,1:ddd mm ss) */
        int outhead;        /* output header (0:no,1:yes) */
        int outopt;         /* output processing options (0:no,1:yes) */
        int datum;          /* datum (0:WGS84,1:Tokyo) */
        int height;         /* height (0:ellipsoidal,1:geodetic) */
        int geoid;          /* geoid model (0:EGM96,1:JGD2000) */
        int solstatic;      /* solution of static mode (0:all,1:single) */
        int sstat;          /* solution statistics level (0:off,1:states,2:residuals) */
        int trace;          /* debug trace level (0:off,1-5:debug) */
        double nmeaintv[2]; /* nmea output interval (s) (<0:no,0:all) */
        /* nmeaintv[0]:gprmc,gpgga,nmeaintv[1]:gpgsv */
        char sep[64];       /* field separator */
        char prog[64];      /* program name */
    } solopt_t;
    
    typedef struct {        /* file options type */
        char satantp[MAXSTRPATH]; /* satellite antenna parameters file */
        char rcvantp[MAXSTRPATH]; /* receiver antenna parameters file */
        char stapos [MAXSTRPATH]; /* station positions file */
        char geoid  [MAXSTRPATH]; /* external geoid data file */
        char iono   [MAXSTRPATH]; /* ionosphere data file */
        char dcb    [MAXSTRPATH]; /* dcb data file */
        char eop    [MAXSTRPATH]; /* eop data file */
        char blq    [MAXSTRPATH]; /* ocean tide loading blq file */
        char tempdir[MAXSTRPATH]; /* ftp/http temporaly directory */
        char geexe  [MAXSTRPATH]; /* google earth exec file */
        char solstat[MAXSTRPATH]; /* solution statistics file */
        char trace  [MAXSTRPATH]; /* debug trace file */
    } filopt_t;
    
    typedef struct {        /* RINEX options type */
        gtime_t ts,te;      /* time start/end */
        double tint;        /* time interval (s) */
        double tunit;       /* time unit for multiple-session (s) */
        double rnxver;      /* RINEX version */
        int navsys;         /* navigation system */
        int obstype;        /* observation type */
        int freqtype;       /* frequency type */
        char mask[6][64];   /* code mask {GPS,GLO,GAL,QZS,SBS,CMP} */
        char staid [32];    /* station id for rinex file name */
        char prog  [32];    /* program */
        char runby [32];    /* run-by */
        char marker[64];    /* marker name */
        char markerno[32];  /* marker number */
        char markertype[32]; /* marker type (ver.3) */
        char name[2][32];   /* observer/agency */
        char rec [3][32];   /* receiver #/type/vers */
        char ant [3][32];   /* antenna #/type */
        double apppos[3];   /* approx position x/y/z */
        double antdel[3];   /* antenna delta h/e/n */
        char comment[MAXCOMMENT][64]; /* comments */
        char rcvopt[256];   /* receiver dependent options */
        unsigned char exsats[MAXSAT]; /* excluded satellites */
        int scanobs;        /* scan obs types */
        int outiono;        /* output iono correction */
        int outtime;        /* output time system correction */
        int outleaps;       /* output leap seconds */
        int autopos;        /* auto approx position */
        gtime_t tstart;     /* first obs time */
        gtime_t tend;       /* last obs time */
        gtime_t trtcm;      /* approx log start time for rtcm */
        char tobs[6][MAXOBSTYPE][4]; /* obs types {GPS,GLO,GAL,QZS,SBS,CMP} */
        int nobs[6];        /* number of obs types {GPS,GLO,GAL,QZS,SBS,CMP} */
    } rnxopt_t;
    
    typedef struct {        /* satellite status type */
        unsigned char sys;  /* navigation system */
        unsigned char vs;   /* valid satellite flag single */
        double azel[2];     /* azimuth/elevation angles {az,el} (rad) */
        double resp[NFREQ]; /* residuals of pseudorange (m) */
        double resc[NFREQ]; /* residuals of carrier-phase (m) */
        unsigned char vsat[NFREQ]; /* valid satellite flag */
        unsigned char snr [NFREQ]; /* signal strength (0.25 dBHz) */
        unsigned char fix [NFREQ]; /* ambiguity fix flag (1:fix,2:float,3:hold) */
        unsigned char slip[NFREQ]; /* cycle-slip flag */
        unsigned int lock [NFREQ]; /* lock counter of phase */
        unsigned int outc [NFREQ]; /* obs outage counter of phase */
        unsigned int slipc[NFREQ]; /* cycle-slip counter */
        unsigned int rejc [NFREQ]; /* reject counter */
        double  gf;         /* geometry-free phase L1-L2 (m) */
        double  gf2;        /* geometry-free phase L1-L5 (m) */
        double  phw;        /* phase windup (cycle) */
        gtime_t pt[2][NFREQ]; /* previous carrier-phase time */
        double  ph[2][NFREQ]; /* previous carrier-phase observable (cycle) */
    } ssat_t;
    
    typedef struct {        /* ambiguity control type */
        gtime_t epoch[4];   /* last epoch */
        int fixcnt;         /* fix counter */
        char flags[MAXSAT]; /* fix flags */
        double n[4];        /* number of epochs */
        double LC [4];      /* linear combination average */
        double LCv[4];      /* linear combination variance */
    } ambc_t;
    
    typedef struct {        /* RTK control/result type */
        sol_t  sol;         /* RTK solution */
        double rb[6];       /* base position/velocity (ecef) (m|m/s) */
        int nx,na;          /* number of float states/fixed states */
        double tt;          /* time difference between current and previous (s) */
        double *x, *P;      /* float states and their covariance */
        double *xa,*Pa;     /* fixed states and their covariance */
        int nfix;           /* number of continuous fixes of ambiguity */
        ambc_t ambc[MAXSAT]; /* ambibuity control */
        ssat_t ssat[MAXSAT]; /* satellite status */
        int neb;            /* bytes in error message buffer */
        char errbuf[MAXERRMSG]; /* error message buffer */
        prcopt_t opt;       /* processing options */
    } rtk_t;
    
    typedef struct {        /* receiver raw data control type */
        gtime_t time;       /* message time */
        gtime_t tobs[MAXSAT][NFREQ+NEXOBS]; /* observation data time */
        obs_t obs;          /* observation data */
        obs_t obuf;         /* observation data buffer */
        nav_t nav;          /* satellite ephemerides */
        sta_t sta;          /* station parameters */
        int ephsat;         /* sat number of update ephemeris (0:no satellite) */
        sbsmsg_t sbsmsg;    /* SBAS message */
        char msgtype[256];  /* last message type */
        unsigned char subfrm[MAXSAT][380];  /* subframe buffer */
        lexmsg_t lexmsg;    /* LEX message */
        double lockt[MAXSAT][NFREQ+NEXOBS]; /* lock time (s) */
        double icpp[MAXSAT],off[MAXSAT],icpc; /* carrier params for ss2 */
        double prCA[MAXSAT],dpCA[MAXSAT]; /* L1/CA pseudrange/doppler for javad */
        unsigned char halfc[MAXSAT][NFREQ+NEXOBS]; /* half-cycle add flag */
        char freqn[MAXOBS]; /* frequency number for javad */
        int nbyte;          /* number of bytes in message buffer */
        int len;            /* message length (bytes) */
        int iod;            /* issue of data */
        int tod;            /* time of day (ms) */
        int tbase;          /* time base (0:gpst,1:utc(usno),2:glonass,3:utc(su) */
        int flag;           /* general purpose flag */
        int outtype;        /* output message type */
        unsigned char buff[MAXRAWLEN]; /* message buffer */
        char opt[256];      /* receiver dependent options */
        double receive_time;/* RT17: Reiceve time of week for week rollover detection */
        unsigned int plen;  /* RT17: Total size of packet to be read */
        unsigned int pbyte; /* RT17: How many packet bytes have been read so far */
        unsigned int page;  /* RT17: Last page number */
        unsigned int reply; /* RT17: Current reply number */
        int week;           /* RT17: week number */
        unsigned char pbuff[255+4+2]; /* RT17: Packet buffer */
    } raw_t;
    
    typedef struct {        /* stream type */
        int type;           /* type (STR_???) */
        int mode;           /* mode (STR_MODE_?) */
        int state;          /* state (-1:error,0:close,1:open) */
        unsigned int inb,inr;   /* input bytes/rate */
        unsigned int outb,outr; /* output bytes/rate */
        unsigned int tick,tact; /* tick/active tick */
        unsigned int inbt,outbt; /* input/output bytes at tick */
        lock_t lock;        /* lock flag */
        void *port;         /* type dependent port control struct */
        char path[MAXSTRPATH]; /* stream path */
        char msg [MAXSTRMSG];  /* stream message */
    } stream_t;
    
    typedef struct {        /* stream converter type */
        int itype,otype;    /* input and output stream type */
        int nmsg;           /* number of output messages */
        int msgs[32];       /* output message types */
        double tint[32];    /* output message intervals (s) */
        unsigned int tick[32]; /* cycle tick of output message */
        int ephsat[32];     /* satellites of output ephemeris */
        int stasel;         /* station info selection (0:remote,1:local) */
        rtcm_t rtcm;        /* rtcm input data buffer */
        raw_t raw;          /* raw  input data buffer */
        rtcm_t out;         /* rtcm output data buffer */
    } strconv_t;
    
    typedef struct {        /* stream server type */
        int state;          /* server state (0:stop,1:running) */
        int cycle;          /* server cycle (ms) */
        int buffsize;       /* input/monitor buffer size (bytes) */
        int nmeacycle;      /* NMEA request cycle (ms) (0:no) */
        int nstr;           /* number of streams (1 input + (nstr-1) outputs */
        int npb;            /* data length in peek buffer (bytes) */
        double nmeapos[3];  /* NMEA request position (ecef) (m) */
        unsigned char *buff; /* input buffers */
        unsigned char *pbuf; /* peek buffer */
        unsigned int tick;  /* start tick */
        stream_t stream[16]; /* input/output streams */
        strconv_t *conv[16]; /* stream converter */
        thread_t thread;    /* server thread */
        lock_t lock;        /* lock flag */
    } strsvr_t;
    
    typedef struct {        /* RTK server type */
        int state;          /* server state (0:stop,1:running) */
        int cycle;          /* processing cycle (ms) */
        int nmeacycle;      /* NMEA request cycle (ms) (0:no req) */
        int nmeareq;        /* NMEA request (0:no,1:nmeapos,2:single sol) */
        double nmeapos[3];  /* NMEA request position (ecef) (m) */
        int buffsize;       /* input buffer size (bytes) */
        int format[3];      /* input format {rov,base,corr} */
        solopt_t solopt[2]; /* output solution options {sol1,sol2} */
        int navsel;         /* ephemeris select (0:all,1:rover,2:base,3:corr) */
        int nsbs;           /* number of sbas message */
        int nsol;           /* number of solution buffer */
        rtk_t rtk;          /* RTK control/result struct */
        int nb [3];         /* bytes in input buffers {rov,base} */
        int nsb[2];         /* bytes in soulution buffers */
        int npb[3];         /* bytes in input peek buffers */
        unsigned char *buff[3]; /* input buffers {rov,base,corr} */
        unsigned char *sbuf[2]; /* output buffers {sol1,sol2} */
        unsigned char *pbuf[3]; /* peek buffers {rov,base,corr} */
        sol_t solbuf[MAXSOLBUF]; /* solution buffer */
        unsigned int nmsg[3][10]; /* input message counts */
        raw_t  raw [3];     /* receiver raw control {rov,base,corr} */
        rtcm_t rtcm[3];     /* RTCM control {rov,base,corr} */
        gtime_t ftime[3];   /* download time {rov,base,corr} */
        char files[3][MAXSTRPATH]; /* download paths {rov,base,corr} */
        obs_t obs[3][MAXOBSBUF]; /* observation data {rov,base,corr} */
        nav_t nav;          /* navigation data */
        sbsmsg_t sbsmsg[MAXSBSMSG]; /* SBAS message buffer */
        stream_t stream[8]; /* streams {rov,base,corr,sol1,sol2,logr,logb,logc} */
        stream_t *moni;     /* monitor stream */
        unsigned int tick;  /* start tick */
        thread_t thread;    /* server thread */
        int cputime;        /* CPU time (ms) for a processing cycle */
        int prcout;         /* missing observation data count */
        lock_t lock;        /* lock flag */
    } rtksvr_t;
    
    extern int  satsys  (int sat, int *prn);
    extern double *mat  (int n, int m);
    extern double norm(const double *a, int n);
    extern int  lsq   (const double *A, const double *y, int n, int m, double *x,
                       double *Q);
    extern char    *time_str(gtime_t t, int n);
    extern gtime_t timeadd  (gtime_t t, double sec);
    extern void ecef2pos(const double *r, double *pos);
    extern void trace_c    (int level, const char *format, ...);
    
#ifdef __cplusplus
}
#endif